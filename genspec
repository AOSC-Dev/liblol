#!/bin/bash

# This script should be run in the rootfs of loongnix DaoXiangHu-stable

set -e -o pipefail

sed -i '/deb-src/s/#//' /etc/apt/sources.list
apt-get update
apt-get install --no-install-recommends -y \
    libgdk-pixbuf2.0-bin \
    libgtk2.0-0 \
    libgtk-3-0

exec 3> spec.new

echo "# AUTOGENERATED FILE from spec.main using genspec" >&3

cat spec.main >&3

fetch_pkg(){
  local pkg="$1"
  local tag="$2"

  [ "$tag" ]

  info=$(apt-get --print-uris download "$pkg")
  if [ "$?" -ne 0 ]; then
    return 1
  fi
  url=$(echo "$info" | sed "s/^[^']*'\([^']*\)'.*$/\1/" | sed 's/^.*\(pool.*\)$/\1/')
  sum=$(echo "$info" | sed 's/^.*SHA256:\([^ ]*\) *.*$/\1/')
  printf 'SRCS="$SRCS file::rename=%s%s.deb::${_mirror}/%s \\\n"\n' "$tag" "$pkg" "$url"
  printf 'CHKSUMS="$CHKSUMS sha256::%s \\\n"\n' "$sum"
}

fetch_src(){
  local pkg="$1"

  info=$(apt-get --print-uris -qq source "$pkg")
  if [ "$?" -ne 0 ]; then
    return 1
  fi
  url=$(echo "$info" | sed "s/^[^']*'\([^']*\)'.*$/\1/" | sed 's/^.*\(pool.*\)$/\1/')
  sum=$(echo "$info" | sed 's/^.*SHA256:\([^ ]*\) *.*$/\1/')
  echo -n 'SRCS="$SRCS '
  echo "$url" | sed 's@^\(.*/\([^/]*\)\)$@file::rename=\2::${_mirror}/\1@; s@$@ \\@'
  echo '"'
  echo -n 'CHKSUMS="$CHKSUMS '
  echo "$sum" | sed 's@^@sha256::@; s@$@ \\@'
  echo '"'
}
while read pkg; do
    if [ -z "$pkg" ]; then
        continue
    fi
    nodbg=0
    dev=0
    src=0
    while :; do
        case $pkg in
            *:nodbg)
                nodbg=1
                pkg=${pkg%:nodbg}
            ;;
            *:src)
                src=1
		pkg=${pkg%:src}
            ;;
            *:dev)
                dev=1
		pkg=${pkg%:dev}
	    ;;
            *)
                break
            ;;
        esac
    done
    case $pkg in
        *-dev)
            devpkg=1
        ;;
        *)
            devpkg=0
        ;;
    esac
    if [ "$src" = "0" ]; then
        tag=""
        if [ "$devpkg" = 0 ]; then
            tag="${tag}dist_"
        fi
	if [ "$dev" = 1 ]; then
            tag="${tag}dev_"
        fi
        fetch_pkg "$pkg" "$tag">&3
        if [ "$nodbg" = "0" ] && [ "$devpkg" = "0" ] ; then
            fetch_pkg "$pkg-dbgsym" "dist_" >&3 || fetch_pkg "$pkg-dbg" "dist_" >&3
        fi
    else
        fetch_src "$pkg" >&3
    fi
done < manifest

exec 3>&-
mv spec.new spec

gen_def_cache(){
    local generator="$1"
    local cache_name="$2"

    exec 3> "autobuild/additional-files/$cache_name.cache.in.new"
    "$generator" | sed "s#/usr/lib/loongarch64-linux-gnu#@libdir@#" >&3
    exec 3>&-
    mv "autobuild/additional-files/$cache_name.cache.in.new" "autobuild/additional-files/$cache_name.cache.in"
}

gen_def_cache "/usr/lib/loongarch64-linux-gnu/gdk-pixbuf-2.0/gdk-pixbuf-query-loaders" "gdk-pixbuf-query-loaders"
HOME='~' gen_def_cache "/usr/lib/loongarch64-linux-gnu/libgtk2.0-0/gtk-query-immodules-2.0" "gtk2-immodules"
gen_def_cache "/usr/lib/loongarch64-linux-gnu/libgtk-3-0/gtk-query-immodules-3.0" "gtk3-immodules"
